---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import Sidebar from '../../components/Sidebar.astro';

import { questions, answers } from '../../data/questions.js';

export async function getStaticPaths() {
  return questions.map(question => ({
    params: { slug: question.slug },
    props: { question }
  }));
}

const { question } = Astro.props;
const allAnswers = answers.filter(answer => answer.questionId === question.id);
const childrenByParent = new Map<number, typeof allAnswers>();
for (const a of allAnswers) {
  const pid = (a as any).parentAnswerId as number | undefined;
  if (pid) {
    if (!childrenByParent.has(pid)) childrenByParent.set(pid, [] as any);
    (childrenByParent.get(pid) as any).push(a);
  }
}
const rootAnswers = allAnswers
  .filter(a => !("parentAnswerId" in (a as any)))
  .sort((a, b) => b.votes - a.votes);

function formatDate(dateString: string) {
  const date = new Date(dateString);
  return date.toLocaleDateString('en-US', { 
    year: 'numeric', 
    month: 'long', 
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });
}

// SEO: Build QAPage JSON-LD from the question and top-level answers
const pageUrl = new URL(`/questions/${question.slug}/`, Astro.site);
const qaJsonLd: any = {
  "@context": "https://schema.org",
  "@type": "QAPage",
  "mainEntity": {
    "@type": "Question",
    "name": question.title,
    "text": question.content,
    "dateCreated": question.createdAt,
    "author": { "@type": "Person", "name": (question as any)?.author?.name ?? "Anonymous" },
    "upvoteCount": question.votes,
    "url": pageUrl.toString(),
    "suggestedAnswer": rootAnswers.map((a) => ({
      "@type": "Answer",
      "text": a.content,
      "dateCreated": a.createdAt,
      "upvoteCount": a.votes,
      "author": { "@type": "Person", "name": (a as any)?.author?.name ?? "Anonymous" }
    }))
  }
};
const jsonLd = JSON.stringify(qaJsonLd);
---

<BaseLayout 
  title={`${question.title} - Quistra`}
  description={question.content.substring(0, 160)}
  canonical={`/questions/${question.slug}/`}
>
  <Fragment slot="head">
    <!-- Targeted SEO tags for Heardirectclub keywords (only for Nova hearing aid page) -->
    <meta name="robots" content="index, follow" />
    {question.slug === 'heardirectclubs-nova-hearing-aid-any-good' && (
      <meta name="keywords" content="heardirectclub, heardirectclub reviews, nova hearing aid, nova hearing aid review, heardirectclubs nova hearing aid" />
    )}
    <!-- Override OG type to article for question pages -->
    <meta property="og:type" content="article" />
    <meta property="article:published_time" content={question.createdAt} />
    <script type="application/ld+json" set:html={jsonLd} />
  </Fragment>
  <Header />
  
  <!-- Breadcrumb -->
  <nav class="bg-gray-50 border-b border-gray-200 py-3">
    <div class="container mx-auto px-4">
      <div class="flex items-center space-x-2 text-sm text-gray-600">
        <a href="/" class="hover:text-coral-600 transition-colors">Home</a>
        <span>/</span>
        <span class="text-gray-900">{question.title}</span>
      </div>
    </div>
  </nav>

  <main class="container mx-auto px-4 py-8" data-slug="{question.slug}">
    <div class="flex flex-col lg:flex-row gap-8">
      <!-- Question Content -->
      <div class="flex-1">
        <!-- Question Header -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
          <div class="flex items-start gap-4">
            <!-- Vote Column -->
            <div class="flex flex-col items-center space-y-2 min-w-[60px]">
              <button class="vote-button upvote-btn" data-type="question" data-id="{question.id}">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
                </svg>
              </button>
              <span class="text-lg font-semibold text-gray-700 vote-count" data-original="{question.votes}">{question.votes}</span>
              <button class="vote-button downvote-btn" data-type="question" data-id="{question.id}">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
              </button>
              
              <!-- Bookmark -->
              <button class="vote-button mt-4">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path>
                </svg>
              </button>
            </div>
            
            <!-- Question Content -->
            <div class="flex-1">
              <h1 class="text-2xl font-bold text-gray-900 mb-4">{question.title}</h1>
              
              <div class="prose max-w-none mb-6">
                <p class="text-gray-700 leading-relaxed">{question.content}</p>
              </div>
              
              <!-- Tags -->
              <div class="flex flex-wrap gap-2 mb-6">
                {question.tags.map(tag => (
                  <a href={`/tags/${tag}`} class="tag hover:bg-gray-200 transition-colors">
                    {tag}
                  </a>
                ))}
              </div>
              
              <!-- Question Meta -->
              <div class="flex items-center justify-between pt-4 border-t border-gray-200">
                <div class="flex items-center space-x-4">
                  <button class="text-sm text-gray-600 hover:text-coral-600 transition-colors">Share</button>
                  <button class="text-sm text-gray-600 hover:text-coral-600 transition-colors">Edit</button>
                  <button class="text-sm text-gray-600 hover:text-coral-600 transition-colors">Follow</button>
                </div>
                
                <div class="flex items-center space-x-3">
                  <div>
                    <div class="text-sm font-medium text-gray-900">{question.author.name}</div>
                  </div>
                  <div class="text-right">
                    <div class="text-xs text-gray-700 ts-el" data-ts="question" data-id="{question.id}">{formatDate(question.createdAt)}</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Answers Section -->
        <div class="mb-6">
          <h2 class="text-xl font-semibold text-gray-900 mb-4">
            {allAnswers.length} Answer{allAnswers.length !== 1 ? 's' : ''}
          </h2>
          
          {allAnswers.length === 0 ? (
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-8 text-center">
              <p class="text-gray-500">No answers yet. Be the first to answer this question!</p>
            </div>
          ) : (
            <div>
              <div id="answers-container" class="space-y-6">
                {rootAnswers.slice(0, 5).map(answer => (
                <article class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                  <div class="flex gap-4">
                    <!-- Vote Column -->
                    <div class="flex flex-col items-center space-y-2 min-w-[60px]">
                      <button class="vote-button upvote-btn" data-type="answer" data-id="{answer.id}">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
                        </svg>
                      </button>
                      <span class="text-lg font-semibold text-gray-700 vote-count" data-original="{answer.votes}">{answer.votes}</span>
                      <button class="vote-button downvote-btn" data-type="answer" data-id="{answer.id}">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                      </button>
                      
                      {answer.isAccepted && (
                        <div class="mt-4">
                          <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                              <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                            </svg>
                          </div>
                        </div>
                      )}
                    </div>
                    
                    <!-- Answer Content -->
                    <div class="flex-1">
                      <div class="prose max-w-none mb-4">
                        <p class="text-gray-700 leading-relaxed whitespace-pre-wrap">{answer.content}</p>
                      </div>
                      
                      <!-- Answer Meta -->
                      <div class="flex items-center justify-end pt-4 border-t border-gray-200">
                        
                        <div class="flex items-center space-x-3">

                          <div>
                            <div class="text-sm font-medium text-gray-900">{answer.author.name}</div>
                          </div>
                          <div class="text-right">
                            <div class="text-xs text-gray-700 ts-el" data-ts="answer" data-id="{answer.id}">{formatDate(answer.createdAt)}</div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  {childrenByParent.get(answer.id)?.length ? (
                    <div class="mt-4 space-y-4 ml-10">
                      {childrenByParent.get(answer.id)!.map(child => (
                        <article class="bg-gray-50 rounded-lg border border-gray-200 p-4">
                          <div class="flex gap-4">
                            <div class="flex flex-col items-center space-y-2 min-w-[60px]">
                              <button class="vote-button upvote-btn" data-type="answer" data-id="{child.id}">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
                                </svg>
                              </button>
                              <span class="text-lg font-semibold text-gray-700 vote-count" data-original="{child.votes}">{child.votes}</span>
                              <button class="vote-button downvote-btn" data-type="answer" data-id="{child.id}">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                              </button>
                            </div>
                            <div class="flex-1">
                              <div class="prose max-w-none mb-4">
                                <p class="text-gray-700 leading-relaxed whitespace-pre-wrap">{child.content}</p>
                              </div>
                              <div class="flex items-center justify-end pt-4 border-t border-gray-200">
                                <div class="flex items-center space-x-3">

                                  <div>
                                    <div class="text-sm font-medium text-gray-900">{child.author.name}</div>
                                  </div>
                                  <div class="text-right">
                                    <div class="text-xs text-gray-500">replied</div>
                                    <div class="text-xs text-gray-700 ts-el" data-ts="answer" data-id="{child.id}">{formatDate(child.createdAt)}</div>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </article>
                      ))}
                    </div>
                  ) : null}
                </article>
                ))}
              </div>
              
              <!-- Hidden answers for pagination -->
              <div id="hidden-answers" class="hidden space-y-6">
                {rootAnswers.slice(5).map(answer => (
                <article class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                  <div class="flex gap-4">
                    <!-- Vote Column -->
                    <div class="flex flex-col items-center space-y-2 min-w-[60px]">
                      <button class="vote-button upvote-btn" data-type="answer" data-id="{answer.id}">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
                        </svg>
                      </button>
                      <span class="text-lg font-semibold text-gray-700 vote-count" data-original="{answer.votes}">{answer.votes}</span>
                      <button class="vote-button downvote-btn" data-type="answer" data-id="{answer.id}">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                      </button>
                      
                      {answer.isAccepted && (
                        <div class="mt-2">
                          <div class="w-6 h-6 bg-green-500 rounded-full flex items-center justify-center">
                            <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                              <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                            </svg>
                          </div>
                        </div>
                      )}
                    </div>
                    
                    <!-- Answer Content -->
                    <div class="flex-1">
                      <div class="prose max-w-none mb-4">
                        <p class="text-gray-700 leading-relaxed whitespace-pre-wrap">{answer.content}</p>
                      </div>
                      
                      <!-- Answer Meta -->
                      <div class="flex items-center justify-end pt-4 border-t border-gray-200">
                        <div class="flex items-center space-x-3">

                          <div>
                            <div class="text-sm font-medium text-gray-900">{answer.author.name}</div>
                            {answer.author.reputation > 0 && (
                              <div class="text-xs text-gray-500">{answer.author.reputation.toLocaleString()} reputation</div>
                            )}
                          </div>
                          <div class="text-right">
                            <div class="text-xs text-gray-700 ts-el" data-ts="answer" data-id="{answer.id}">{formatDate(answer.createdAt)}</div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  {/* Child answers (replies) */}
                  {childrenByParent.has(answer.id) ? (
                    <div class="ml-16 mt-6 space-y-4">
                      {childrenByParent.get(answer.id)?.map(child => (
                        <article class="bg-gray-50 rounded-lg border border-gray-200 p-4">
                          <div class="flex gap-4">
                            <div class="flex flex-col items-center space-y-2 min-w-[50px]">
                              <button class="vote-button text-sm">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
                                </svg>
                              </button>
                              <span class="text-lg font-semibold text-gray-700">{child.votes}</span>
                              <button class="vote-button text-sm">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                              </button>
                            </div>
                            <div class="flex-1">
                              <div class="prose max-w-none mb-4">
                                <p class="text-gray-700 leading-relaxed whitespace-pre-wrap">{child.content}</p>
                              </div>
                              <div class="flex items-center justify-end pt-4 border-t border-gray-200">
                                <div class="flex items-center space-x-3">

                                  <div>
                                    <div class="text-sm font-medium text-gray-900">{child.author.name}</div>
                                  </div>
                                  <div class="text-right">
                                    <div class="text-xs text-gray-500">replied</div>
                                    <div class="text-xs text-gray-700 ts-el" data-ts="answer" data-id="{child.id}">{formatDate(child.createdAt)}</div>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </article>
                      ))}
                    </div>
                  ) : null}
                </article>
                ))}
              </div>
              
              <!-- Load More Button -->
              {rootAnswers.length > 5 && (
                <div class="text-center mt-6">
                  <button 
                    id="load-more-btn" 
                    class="bg-coral-600 hover:bg-coral-700 text-white px-6 py-3 rounded-lg font-medium transition-colors duration-200 shadow-sm hover:shadow-md"
                  >
                    Load More Answers
                  </button>
                </div>
              )}
            </div>
          )}
        </div>

        <!-- Answer Form -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Leave a Reply</h3>
          <form class="space-y-4">
            <div>
              <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Name *</label>
              <input 
                type="text" 
                id="name"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-coral-500 focus:border-transparent"
                required
              >
            </div>
            <div>
              <label for="website" class="block text-sm font-medium text-gray-700 mb-1">Website</label>
              <input 
                type="url" 
                id="website"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-coral-500 focus:border-transparent"
              >
            </div>
            <div>
              <label for="comment" class="block text-sm font-medium text-gray-700 mb-1">Comment *</label>
              <textarea 
                id="comment"
                rows="6"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-coral-500 focus:border-transparent"
                required
              ></textarea>
            </div>
            <button type="submit" class="btn-primary">
              Post your answer
            </button>
          </form>
        </div>
      </div>

      <!-- Sidebar -->
      <Sidebar />
    </div>
  </main>

  <Footer />
</BaseLayout>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Voting functionality
    initializeVoting();
    
    // Dynamic timestamp generation for a specific slug (Nova hearing aid page)
    try {
      const mainEl = document.querySelector('main[data-slug]');
      const pageSlug = mainEl?.getAttribute('data-slug') || '';
      if (pageSlug === 'heardirectclubs-nova-hearing-aid-any-good') {
        initializeRandomTimestamps(pageSlug);
      }
    } catch (e) {
      // noop
    }
    
    const loadMoreBtn = document.getElementById('load-more-btn');
    const hiddenAnswers = document.getElementById('hidden-answers');
    const answersContainer = document.getElementById('answers-container');
    
    if (loadMoreBtn && hiddenAnswers) {
      let currentPage = 1;
      const answersPerPage = 5;
      const hiddenAnswerElements = Array.from(hiddenAnswers.children);
      const totalHiddenAnswers = hiddenAnswerElements.length;
      
      loadMoreBtn.addEventListener('click', function() {
        // Calculate how many answers to show next
        const startIndex = (currentPage - 1) * answersPerPage;
        const endIndex = Math.min(startIndex + answersPerPage, totalHiddenAnswers);
        
        // Move answers from hidden container to visible container
        for (let i = startIndex; i < endIndex; i++) {
          if (hiddenAnswerElements[i]) {
            answersContainer.appendChild(hiddenAnswerElements[i]);
          }
        }
        
        currentPage++;
        
        // Update button text or hide it if no more answers
        const remainingAnswers = totalHiddenAnswers - (endIndex);
        if (remainingAnswers > 0) {
          loadMoreBtn.textContent = 'Load More Answers';
        } else {
          loadMoreBtn.style.display = 'none';
        }
        
        // Smooth scroll to the newly loaded content
        const newlyAddedAnswer = hiddenAnswerElements[startIndex];
        if (newlyAddedAnswer) {
          setTimeout(() => {
            newlyAddedAnswer.scrollIntoView({ 
              behavior: 'smooth', 
              block: 'start',
              inline: 'nearest'
            });
          }, 100);
        }
      });
    }
    
    // Initialize voting functionality
    function initializeVoting() {
      // Get all vote buttons
      const upvoteButtons = document.querySelectorAll('.upvote-btn');
      const downvoteButtons = document.querySelectorAll('.downvote-btn');
      
      // Load existing votes from localStorage
      const votes = JSON.parse(localStorage.getItem('quistra_votes') || '{}');
      
      // Apply existing vote states
      applyVoteStates(votes);
      
      // Add click handlers for upvote buttons
      upvoteButtons.forEach(button => {
        button.addEventListener('click', function(e) {
          e.preventDefault();
          const type = this.dataset.type;
          const id = this.dataset.id;
          const key = `${type}_${id}`;
          
          // Toggle upvote
          if (votes[key] === 'up') {
            delete votes[key];
          } else {
            votes[key] = 'up';
          }
          
          // Save to localStorage
          localStorage.setItem('quistra_votes', JSON.stringify(votes));
          
          // Update UI
          applyVoteStates(votes);
        });
      });
      
      // Add click handlers for downvote buttons
      downvoteButtons.forEach(button => {
        button.addEventListener('click', function(e) {
          e.preventDefault();
          const type = this.dataset.type;
          const id = this.dataset.id;
          const key = `${type}_${id}`;
          
          // Toggle downvote
          if (votes[key] === 'down') {
            delete votes[key];
          } else {
            votes[key] = 'down';
          }
          
          // Save to localStorage
          localStorage.setItem('quistra_votes', JSON.stringify(votes));
          
          // Update UI
          applyVoteStates(votes);
        });
      });
    }
    
    function applyVoteStates(votes) {
      // Reset all buttons first
      document.querySelectorAll('.upvote-btn, .downvote-btn').forEach(btn => {
        btn.classList.remove('voted-up', 'voted-down');
      });
      
      // Apply vote states and update counts
      Object.keys(votes).forEach(key => {
        const [type, id] = key.split('_');
        const voteType = votes[key];
        
        const upBtn = document.querySelector(`.upvote-btn[data-type="${type}"][data-id="${id}"]`);
        const downBtn = document.querySelector(`.downvote-btn[data-type="${type}"][data-id="${id}"]`);
        const countSpan = document.querySelector(`.vote-count[data-original][data-type="${type}"][data-id="${id}"]`) ||
                         upBtn?.parentElement.querySelector('.vote-count[data-original]');
        
        if (countSpan) {
          const originalCount = parseInt(countSpan.dataset.original);
          let newCount = originalCount;
          
          if (voteType === 'up') {
            newCount = originalCount + 1;
            upBtn?.classList.add('voted-up');
          } else if (voteType === 'down') {
            newCount = originalCount - 1;
            downBtn?.classList.add('voted-down');
          }
          
          countSpan.textContent = newCount;
        }
      });
    }
    
    // Timestamp utilities and initializer
    function initializeRandomTimestamps(slug) {
      const storageKey = `quistra_ts_${slug}`;
      const now = new Date();
      const sixMonthsAgo = new Date(now);
      sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
      
      // Load existing cache
      const cache = safeParse(localStorage.getItem(storageKey)) || { question: null, answers: {} };
      
      // Collect DOM nodes
      const questionNode = document.querySelector('.ts-el[data-ts="question"]');
      const answerNodes = Array.from(document.querySelectorAll('.ts-el[data-ts="answer"][data-id]'));
      
      // Generate question timestamp if missing
      if (!cache.question) {
        cache.question = randomDateBetween(sixMonthsAgo, now).toISOString();
      }
      const questionDate = new Date(cache.question);
      
      // Ensure answers exist after question
      answerNodes.forEach((node) => {
        const id = node.getAttribute('data-id');
        if (!id) return;
        if (!cache.answers[id]) {
          cache.answers[id] = randomDateBetween(questionDate, now).toISOString();
        }
      });
      
      // Persist
      localStorage.setItem(storageKey, JSON.stringify(cache));
      
      // Apply to DOM with consistent formatting
      if (questionNode && cache.question) {
        questionNode.textContent = formatDateClient(cache.question);
      }
      answerNodes.forEach((node) => {
        const id = node.getAttribute('data-id');
        const ts = id ? cache.answers[id] : null;
        if (ts) node.textContent = formatDateClient(ts);
      });
    }
    
    function randomDateBetween(start, end) {
      const startMs = start.getTime();
      const endMs = end.getTime();
      const t = startMs + Math.random() * Math.max(0, endMs - startMs);
      return new Date(t);
    }
    
    function formatDateClient(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }
    
    function safeParse(str) {
      try { return str ? JSON.parse(str) : null; } catch { return null; }
    }
  });
</script>
